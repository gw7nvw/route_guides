<div id="route_details">    
   <% if !@itemNumber then @itemNumber=1 else @itemNumber+=1 end %>
   <% if @route.experienced_at==nil %>
     <div class="erow" id="expwarning<%=@itemNumber.to_s%>">
             <p style='color:red'>Warning: this route segment has not been experienced by the author</p>
     </div>
   <% end %>
   <div class="erow">
      <%=render :partial => 'expand_buttons',  :locals => {:expName => "route"+@itemNumber.to_s, :initialSt => (if @hideAll then 0 else 1 end)} %>
  
      <%  if(signed_in? and @trip and @trip.class.to_s!="Trip" and !@history) %>
         <%
            thisEditUrl=@url.gsub('xrv'+@route.id.to_s,'xre'+@route.id.to_s).gsub('xqv'+@route.id.to_s,'xqe'+@route.id.to_s)
         %>
         <div class="leftbuttons">
            <span title="Edit" id="edit<%=@itemNumber.to_s%>">
               <%=  link_to image_tag("/assets/pencil_edit.png", :border=>0, :class => 'dock-item'), thisEditUrl, remote: true, onclick: "linkHandler('editbutton')", id:  "editbutton"  %>
            </span>
         </div>
      <% end %> 
      <%  if(signed_in? and !@trip and !@history) %>
         <div class="leftbuttons50">
            <span title="Edit">
               <%=  link_to image_tag("/assets/pencil_edit.png", :border=>0, :class => 'dock-item'), '/routes/'+@route.id.to_s+'/edit', remote: true, onclick: "linkHandler('editbutton')", id:  "editbutton"  %>
            </span>
            <span title="Split">
               <%=  link_to image_tag("/assets/axe16.png", :border=>0, :class => 'dock-item'), '/routes/xrc'+@route.id.to_s+'xps', remote: true, onclick: "linkHandler('splitbutton')", id:  "splitbutton"  %>
            </span>
         </div>
      <% end %>

      <div class="sectiontitle25" id="route_title<%=@itemNumber.to_s%>">
         <% if @real_startplace then startplace= @real_startplace else startplace=@route.startplace end %>
         <% if @real_endplace then endplace= @real_endplace else endplace=@route.endplace end %>
         <% if !@route.published then %>Draft:<% end %>
         <% if !@history %>
            <%= link_to startplace.name+" to "+endplace.name+" via "+@route.via, 
               @route, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %>
              <% if !@trip %> <%=  link_to "Download GPX", '/routes/'+@route.id.to_s+'.gpx?version='+@version.to_s, class: "btn btn-small btn-primary no-print", style: "font-weight:normal" %> <% end %>
         <% else %>
            <%=startplace.name+" to "+endplace.name+" via "+@route.via %>
         <% end %>

      </div>
   </div>
   <div id='route<%=@itemNumber.to_s%>' style='display:<%=if @hideAll then "none" else "block" end%>'>
      <div class="subrow">
         <%=render :partial => 'expand_buttons',  :locals => {:expName => "cn_r"+@itemNumber.to_s, :initialSt => @showConditions} %>
         <div class="sectiontext25">
           <span id="route_dist<%=@itemNumber.to_s%>">
             <% if @route.distance and @route.distance>0%>
                <%= "Distance: "+@route.distance.round(1).to_s+" km  " %>
             <%end %>
           </span>
           <span id="route_time<%=@itemNumber.to_s%>">
           <% if @route.time %>
              <%="("+@route.time.round(1).to_s+" DOC hours)"  %>
           <% end %>
           </span>
           <span id="route_type<%=@itemNumber.to_s%>">
           <% if @route.routetype.name!='Unknown'%>
              <%=" - "+@route.routetype.name%>
           <% end %>
           </span>
           <span id="route_terr<%=@itemNumber.to_s%>">
           <% if @route.terrain.name!='Unknown'%>
              <%=" - "+@route.terrain.name+" terrain"%>
           <% end %>
           </span>
           <% if @route.location and !@history and (@route.maxalt+@route.minalt)>0%>
              <br/>
              <span id="route_alti<%=@itemNumber.to_s%>">
              <%= "Altitude: "+@route.minalt.to_i.to_s+"m to "+@route.maxalt.to_i.to_s+"m."+
                 "  Gain: "+@route.altgain.to_i.to_s+"m.  Loss: "+@route.altloss.to_i.to_s+"m" %>
              </span>
              <span id="route_grad<%=@itemNumber.to_s%>">
              <% if @route.distance>0 %>
                 <%=".  Gradient: "+(Math.tan((@route.altgain+@route.altloss)/(@route.distance*1000))*180/Math::PI).round().to_s+" deg"%>
              <% end %>
              </span>
              <span id="gradien_smry<%=@itemNumber.to_s%>"><% if @route.gradient.name!='Unknown'%>
                 <%="("+@route.gradient.name+")"%>
              <% end %></span>
           <% end %><br/>
           Skills:  
           <span id="alpines_smry<%=@itemNumber.to_s%>"><% if @route.alpinesummer.name!='Unknown' and @route.alpinesummer.name!='None' %>
              <%=@route.alpinesummer.name%><%=" ("+(@route.alpinesummer_id-@alpines.minimum(:id)).to_s+"/"+(@alpines.maximum(:id)-@alpines.minimum(:id)).to_s+") "%> 
           <% end %></span>
           <span id="rivers_smry<%=@itemNumber.to_s%>"><% if @route.river.name!='Unknown' and @route.river.name!='None' %>
              <%=" - "+@route.river.name%>
              <%=" ("+(@route.river_id-@rivers.minimum(:id)).to_s+"/"+(@rivers.maximum(:id)-@rivers.minimum(:id)).to_s+") "%>
           <% end %></span>
           <span id="alpinew_smry<%=@itemNumber.to_s%>"><% if @route.alpinewinter.name!='Unknown' and @route.alpinewinter.name!='None' %>
              Winter - <%=@route.alpinewinter.name%>
              <%=" ("+(@route.alpinewinter_id-@alpinews.minimum(:id)).to_s+"/"+(@alpinews.maximum(:id)-@alpinews.minimum(:id)).to_s+")"%>
           <% end %></span>
           <br/>
           <div class="no-print" id="gpx<%=@itemNumber.to_s%>">
                <i><%= "GPX info source: "+@route.datasource %></i>
           </div>
         </div>
       </div>
       <div class="subrow">
         <div id='<%="cn_r"+@itemNumber.to_s%>' class="sectiontext" style=<%=if (@showConditions==1) then "display:block" else "display:none" end %>>
           <p>
              <div class="diff_label">Route Type:</div> <span id="type_text<%=@itemNumber.to_s%>"><%=@route.routetype.name%></span>
              <%="("+(@route.routetype_id-@route_types.minimum(:id)).to_s+"/"+(@route_types.maximum(:id)-@route_types.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.routetype.description%></i>
           </p>
           <p>
              <div class="diff_label">Route Importance:</div> <span id="impo_text<%=@itemNumber.to_s%>"><%=@route.importance.name%></span>
              <%="("+(@route.importance_id-@importances.minimum(:id)+1).to_s+"/"+(@importances.maximum(:id)-@importances.minimum(:id)+1).to_s+")"%><br/>
              <i><%=@route.importance.description%></i>
           </p>
           <p>
              <div class="diff_label">Gradient:</div> <span id="grad_text<%=@itemNumber.to_s%>"><%=@route.gradient.name%></span>
              <%="(difficulty: "+(@route.gradient_id-@gradients.minimum(:id)).to_s+"/"+(@gradients.maximum(:id)-@gradients.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.gradient.description%></i>
           </p>
           <p>
              <div class="diff_label">Terrain:</div> <span id="terr_text<%=@itemNumber.to_s%>"><%=@route.terrain.name%></span>
              <%="(difficulty: "+(@route.terrain_id-@terrains.minimum(:id)).to_s+"/"+(@terrains.maximum(:id)-@terrains.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.terrain.description%></i>
           </p>
           <p>
              <div class="diff_label">Alpine:</div> <span id="alps_text<%=@itemNumber.to_s%>"><%=@route.alpinesummer.name%></span>
              <%="(difficulty: "+(@route.alpinesummer_id-@alpines.minimum(:id)).to_s+"/"+(@alpines.maximum(:id)-@alpines.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.alpinesummer.description%></i>
           </p>
           <p>
              <div class="diff_label">Rivers:</div> <span id="rive_text<%=@itemNumber.to_s%>"><%=@route.river.name%></span>
              <%="(difficulty: "+(@route.river_id-@rivers.minimum(:id)).to_s+"/"+(@rivers.maximum(:id)-@rivers.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.river.description%></i>
           </p>

           <div class="sectiontitle">Winter conditions:</div><br/>
           <p>
              <div class="diff_label">Alpine:</div> <span id="alpw_text<%=@itemNumber.to_s%>"><%=@route.alpinewinter.name%></span>
              <%="(difficulty: "+(@route.alpinewinter_id-@alpinews.minimum(:id)).to_s+"/"+(@alpinews.maximum(:id)-@alpinews.minimum(:id)).to_s+")"%><br/>
              <i><%=@route.alpinewinter.description%></i>
           </p>
           <p><span id="winterdesc<%=@itemNumber.to_s%>">
              <%= simple_format(@route.winterdescription).html_safe %>
           </span></p>
         </div>
       </div>
       <div class="subrow">
          <div class="leftbuttons">
            <% if !@edittrippage %>
              <img id='switch<%=@itemNumber.to_s%>' src="/assets/switch.png" <%=%q[onclick=clickswitch(']+@itemNumber.to_s+%q[')]%>>
            <% end %>
          </div>
          <% if (!@route.description or @route.description.length<2)  and ( @route.reverse_description and @route.reverse_description.length>2) then @showForward=0 end%>
          <div id='<%="fw_t"+@itemNumber.to_s%>' class="sectiontitle" style='display:<%=if @showForward==1 then "block" else "none" end%>'>  
             <% if (!@trip and !@history) %>
                <%= form_for  @route, :html => {:name => 'routeform'}, remote: true  do |f| %>
                    From <%= link_to @route.startplace.name,    @route.startplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> to <%= link_to @route.endplace.name,    @route.endplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> 
                    <%= f.submit "Add to trip", class: "btn btn-small btn-primary", name: "addfw", onclick: "linkHandler('addbutton')", id:  "addbutton" %>  
                <% end %>
             <% else %>
                From <%= link_to @route.startplace.name,    @route.startplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> to <%= link_to @route.endplace.name,    @route.endplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> 
             <% end %>
          </div>
          <div id='<%="fw_r"+@itemNumber.to_s%>' class="sectiontext" style="display:<%=if @showForward==1 then "block" else "none" end%>">         
              <p>
                 <% if @route.description and @route.description.length>0 %>
                    <%= simple_format(@route.description).html_safe %>
                 <% else %>
                   No description
                 <% end %>
              </p>
          </div>


          <div id='<%="rv_t"+@itemNumber.to_s%>' class="sectiontitle" style='display:<%=if @showForward!=1 then "block" else "none" end%>'>
             <% if (!@trip and !@history) %>
                <%= form_for  @route, :html => {:name => 'routeform'}, remote: true  do |f| %>
                    From <%= link_to @route.endplace.name,    @route.endplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> to <%= link_to @route.startplace.name,    @route.startplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %>
                    <%= f.submit "Add to trip", class: "btn btn-small btn-primary", name: "addrv", onclick: "linkHandler('addbutton')", id:  "addbutton" %>
                <% end %>
             <% else %>
                From <%= link_to @route.endplace.name,    @route.endplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %> to <%= link_to @route.startplace.name,    @route.startplace, remote:true,  remote: true, :id => 'home_link', :onclick => "linkHandler('home_link')" %>
             <% end %>

          </div>
          <div id='<%="rv_r"+@itemNumber.to_s%>' class="sectiontext" style='display:<%=if @showForward!=1 then "block" else "none" end%>'>
             <p style='color:red'>Note: Described in the reverse direction to your journey</p>
             <p>
                <span id='<%="rv_d"+@itemNumber.to_s%>'>
                <% if @route.reverse_description and @route.reverse_description.length>0 %>
                  <%= simple_format(@route.reverse_description).html_safe %>
                <% else %>
                  No description
                <% end %>
                </span>
             </p>
          </div>
       </div>

    
       <% if @history or @trip or @routeInstances.count<2%>
          <div class="erow" id="created"> <small color="greyLight">
              Created by: <%= link_to @route.createdBy.name.capitalize, '/users/'+@route.createdBy.name, remote: true%> on <%=@route.firstcreated_at.localtime().strftime("%F")%><% if @route.firstexperienced_at and @route.firstexperienced_at.strftime("%F")>"1900-01-01"%>. Experienced: <%=@route.firstexperienced_at.strftime("%F")%><%end%>
          </small></div>
          <% if !@history and @route.updated_at.to_i!=@route.firstcreated_at.to_i%>
             <div class="erow" id="updated"> <small color="greyLight">
               Last updated by: <%= link_to @route.updatedBy.name.capitalize, '/users/'+@route.createdBy.name, remote: true%> at <%=@route.updated_at.localtime().strftime("%F %T")%><% if @route.experienced_at and @route.experienced_at.strftime("%F")>"1900-01-01"%>. Experienced: <%=@route.experienced_at.strftime("%F")%><%end%>
             </small> </div>
          <% end %>
               
       <% else %>
          <div class="erow" id="versions">
            <div class="rowtitle">Versions:
              <% if !@history and signed_in?%>
                <small color="greyLight" style="font-weight:normal">
                   <%= link_to "(Manage versions)", '/history/route-'+@route.id.to_s, remote: true, :id => 'history', :onclick =>"linkHandler('history')" %>
                </small>
              <% end %>
            </div>
          </div>
          <div class="erow">
            <%=select_tag("versions", options_from_collection_for_select(@routeInstances.order(:updated_at).reverse, "id", "readable_name", @version), {:multiple => :multiple, :size => [3, @routeInstances.count].min, :onchange => 'showVersion()', :class=>'body-select'})%>
          </div>
       <% end %>
   </div>
</div>
<% if !@dontMark %>
<script>

 route_init('<%=@route.startplace.location%>', '<%=@route.endplace.location%>', '<%=@route.location%>', 1);

</script>

<% end %>
