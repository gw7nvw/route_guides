require 'test_helper'

class TripsIndexTest < ActionDispatch::IntegrationTest

  def setup
    init()
  end


# trip indexa
test "view trip index as stranger" do
  get '/trips'
  assert_response :success
  assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "test trip 1 by Example user1"
   assert_select "div#tripstats1", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 3 by Example user1"
   assert_select "div#tripstats2", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 4 by Example user2"
   assert_select "div#tripstats3", "2.0 to 4.0 days | 1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"
   #no more rows
   assert_select "span#triprow4", false
   #no ticks
   assert_select "input#selectCurrent", false
   #no delete
   assert_select "input#Delete", false
   #no add
   assert_select "a#addbutton", false
end

test "view trip index as guest" do
   add_route_to_trip_fw(@route)
   @guest=Guest.find_by_id(session[:guest_id]) 

   assert is_guest?
   trip=@guest.currenttrip_id

   get '/trips'
  assert_response :success
  assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "test trip 1 by Example user1"
   assert_select "div#tripstats1", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 3 by Example user1"
   assert_select "div#tripstats2", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 4 by Example user2"
   assert_select "div#tripstats3", "2.0 to 4.0 days | 1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow4", "(draft) My Trip"
   assert_select "div#tripstats4", "1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "div#selectedrow4"

   #no more rows
   assert_select "span#triprow5", false
   #no ticks
   assert_select "input#selectCurrent", false
   #no delete
   assert_select "input#Delete", false
   #no add
   assert_select "a#addbutton", false
end


 #user - published plus own
   #own tick and green
test "view trip index as user" do
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save

   get '/trips'
   assert_response :success
   assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "div#tripstats1", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "div#tripstats2", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "div#tripstats3", "(updated "+Time.now().strftime("%F")+")"
   assert_select "div#selectedrow3"
   assert_select "span#triprow4", "test trip 4 by Example user2"
   assert_select "div#tripstats4", "2.0 to 4.0 days | 1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"

   #no more rows
   assert_select "span#triprow5", false
   #ticks for my 3 entries, not for other users'
   assert_select "input#selectCurrent", 3
   #no delete
   assert_select "input#Delete", false
   #no add
   assert_select "a#addbutton", false

   #different user
    delete signout_path
    follow_redirect!
    assert_not is_logged_in?

   login_as(@user2.name, "password")
   assert is_logged_in?

  get '/trips'
   assert_response :success
   assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "test trip 1 by Example user1"
   assert_select "div#tripstats1", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 3 by Example user1"
   assert_select "div#tripstats2", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 4 by Example user2"
   assert_select "div#tripstats3", "2.0 to 4.0 days | 1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"

   #no more rows
   assert_select "span#triprow4", false
   #ticks for my 1 entries, not for other users'
   assert_select "input#selectCurrent", 1
   #no delete
   assert_select "input#Delete", false
   #no add
   assert_select "a#addbutton", false
end

 #root - all
   #own tick and green
test "view trip index as root" do
   login_as(@user3.name, "password")
   assert is_logged_in?

   get '/trips'
   assert_response :success
   assert_select "div#page_title", "Trips"
   # root sees all deafts
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "div#tripstats1", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "div#tripstats2", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "div#tripstats3", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow4", "test trip 4 by Example user2"
   assert_select "div#tripstats4", "2.0 to 4.0 days | 1.00 km | 3.0 DOC hrs (updated "+Time.now().strftime("%F")+")"

   #no more rows
   assert_select "span#triprow5", false
   #ticks for all entries
   assert_select "input#selectCurrent", 4
   #no delete
   assert_select "input#Delete", false
   #no add
   assert_select "a#addbutton", false
end

#my trips (wishlist) guest
test "view My Trips as guest" do
   add_place_to_trip(@place)
   assert is_guest?

   get '/wishlist'
   assert_response :success
   assert_select "div#page_title", "My Trips"
   assert_select "span#triprow1", "(draft) My Trip"
   assert_select "div#tripstats1", "(updated "+Time.now().strftime("%F")+")"
   #no more rows
   assert_select "span#triprow2", false
   #no ticks
   assert_select "input#selectCurrent", false
   # delete
   assert_select "input#Delete", 1
   # add
   assert_select "a#addbutton", false
end

#my trips (wishlist) suer
test "view My Trips as user" do
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save

   get '/wishlist'
   assert_response :success
   assert_select "div#page_title", "My Trips"
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "div#tripstats1", "(updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "div#tripstats2", "1.0 to 3.0 days | 3.00 km | 3.5 DOC hrs (updated "+Time.now().strftime("%F")+")"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "div#tripstats3", "(updated "+Time.now().strftime("%F")+")"
   assert_select "div#selectedrow3"

   #no more rows
   assert_select "span#triprow4", false
   #ticks for my 3 entries, not for other users'
   assert_select "input#selectCurrent", 3
   # delete
   assert_select "input#Delete", 3
   # add
   assert_select "a#addbutton[alt=?]", "Add"
end

#selelct a trip (user, wishlist)
test "select different current trip from wishlist" do
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save

   get '/wishlist'
   assert_response :success
   
   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'wishlist',
                         commit: 'Select as current' }
   assert_response :success
   @user.reload
   assert @user.currenttrip_id, @trip1.id

   #redisplays wishlist with new trip selected
   assert_select "div#page_title", "My Trips"
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "div#selectedrow2"

   assert_select "span#triprow4", false
   assert_select "input#selectCurrent", 3
   assert_select "input#Delete", 3
   assert_select "a#addbutton[alt=?]", "Add"
end
#select a trip (user, index)
test "select different current trip from index" do
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save

   get '/trips'
   assert_response :success
   
   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'index',
                         commit: 'Select as current' }
   assert_response :success
   @user.reload
   assert @user.currenttrip_id, @trip1.id

   #ticks for my 3 entries, not for other users'

   #redisplays index with new trip selected
   assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "span#triprow4", "test trip 4 by Example user2"
   assert_select "div#selectedrow2"
   assert_select "span#triprow5", false
   assert_select "input#selectCurrent", 3
   assert_select "input#Delete", false
   assert_select "a#addbutton", false
end

#seelct a trip (root) of another user
test "select different current trip from index as root" do
   login_as(@user3.name, "password")
   assert is_logged_in?
   @user3.currenttrip=@trip3
   @user3.save

   get '/trips'
   assert_response :success

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'index',
                         commit: 'Select as current' }
   assert_response :success
   @user3.reload
   assert @user3.currenttrip_id, @trip1.id

   #ticks for my 3 entries, not for other users'

   #redisplays index with new trip selected
   assert_select "div#page_title", "Trips"
   assert_select "span#triprow1", "(draft) test trip 2 by Example user1"
   assert_select "span#triprow2", "test trip 1 by Example user1"
   assert_select "span#triprow3", "test trip 3 by Example user1"
   assert_select "span#triprow4", "test trip 4 by Example user2"
   assert_select "div#selectedrow2"
   assert_select "span#triprow5", false
   #root can select any of 4
   assert_select "input#selectCurrent", 4
   assert_select "input#Delete", false
   assert_select "a#addbutton", false
end

#cannot select another users trip (user)
test "select another user's trip disallowed (user)" do
   login_as(@user2.name, "password")
   assert is_logged_in?
   @user2.currenttrip=@trip3
   @user2.save

   get '/trips'
   assert_response :success

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'index',
                         commit: 'Select as current' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "Trips"
   @user2.reload
   #but trip not changed
   assert @user2.currenttrip_id, @trip3.id


   get '/wishlist'
   assert_response :success

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'wishlist',
                         commit: 'Select as current' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "My Trips"
   @user2.reload
   #but trip not changed
   assert @user2.currenttrip_id, @trip3.id
end
#cannot select another users trip (guest)
test "select another user's trip disallowed (guest)" do
   add_place_to_trip(@place)
   assert is_guest?
   @guest=Guest.find_by_id(session[:guest_id])
   old_trip=@guest.currenttrip_id
   get '/trips'
   assert_response :success

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'index',
                         commit: 'Select as current' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "Trips"
   #but trip not changed
   assert is_guest?
   @guest.reload
   assert_equal @guest.currenttrip_id, old_trip


   get '/wishlist'
   assert_response :success

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'wishlist',
                         commit: 'Select as current' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "My Trips"
   #but trip not changed
   assert_equal @guest.currenttrip_id, old_trip
end

#delete a trip (user)
test "delete our trips" do
   #DELETE TRIP NOT CURRENT
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save
   oldid=@trip1.id
   oldcnt=Trip.count

   get '/trips'
   assert_response :success
   assert_select "span#triprow4"
   assert_select "span#triprow5", false

   post '/trips/move', { selected_id:  @trip1.id,
                         referring_page: 'index',
                         commit: 'Delete' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "Trips"
   #assert_select  "div.alert", "Trip deleted"

   @user.reload
   #but trip not changed
   assert_equal @user.currenttrip_id, @trip3.id
   #trip and details deleted
   assert_not Trip.find_by_id(oldid)
   assert_equal TripDetail.where(:trip_id => oldid).count, 0
   assert_equal Trip.count, oldcnt-1
   assert_select "span#triprow3"
   assert_select "span#triprow4", false


   #DELETE TRIP CURRENT
 
   oldid=@trip3.id
   oldcnt=Trip.count

   get '/trips'
   assert_response :success
                    
   post '/trips/move', { selected_id:  @trip3.id,
                         referring_page: 'index',
                         commit: 'Delete' }    
   #page reloads      
   assert_response :success
   assert_select "div#page_title", "Trips"        
   assert_select  "div.alert", "Trip deleted"

   @user.reload
   #currenttrip changed to last remaining trip for this user
   assert_equal @user.currenttrip_id, @trip2.id
   #trip and details deleted
   assert_not Trip.find_by_id(oldid)
   assert_equal TripDetail.where(:trip_id => oldid).count, 0
   assert_equal Trip.count, oldcnt-1
   assert_select "span#triprow2"
   assert_select "span#triprow3", false
   

   #DELETE TRIP CURRENT, LAST
 
   oldid=@trip2.id
   oldcnt=Trip.count

   get '/trips'
   assert_response :success
                    
   post '/trips/move', { selected_id:  @trip2.id,
                         referring_page: 'index',
                         commit: 'Delete' }    
   #page reloads      
   assert_response :success
   assert_select "div#page_title", "Trips"        
   assert_select  "div.alert", "Trip deleted"

   @user.reload
   #currenttrip changed to new trip
   assert_not_equal @user.currenttrip_id, @trip2.id
   assert_equal @user.currenttrip_id, Trip.last.id
   #trip and details deleted put nrw one added
   assert_not Trip.find_by_id(oldid)
   assert_equal TripDetail.where(:trip_id => oldid).count, 0
   assert_equal Trip.count, oldcnt
   assert_select "span#triprow2", "Default"
   assert_select "span#triprow3", false

   #new trip created
   newtrip=Trip.find_by_id(@user.currenttrip_id)
   assert_equal newtrip.name, "Default"
   assert_equal newtrip.createdBy_id, @user.id

end

#cannot delete another users trip (user)
test "cannot delete others trips" do
   #DELETE TRIP NOT CURRENT
   login_as(@user.name, "password")
   assert is_logged_in?
   @user.currenttrip=@trip3
   @user.save
   oldid=@trip4.id
   oldcnt=Trip.count

   get '/trips'
   assert_response :success
   assert_select "span#triprow4"
   assert_select "span#triprow5", false

   post '/trips/move', { selected_id:  @trip4.id,
                         referring_page: 'index',
                         commit: 'Delete' }
   #page reloads
   assert_response :success
   assert_select "div#page_title", "Trips"
   assert_select  "div.alert", "Cannot delete trip"

   #trip and details deleted
   assert Trip.find_by_id(oldid)
   assert_equal Trip.count, oldcnt
   assert_select "span#triprow4"
   assert_select "span#triprow5", false
end


#delete a trip (guest)

#cannot delete another users trip (guest)

#delete anothers users trip (root)
  #nb check no users have this as current_trip afterwards

#add a trip (user)

#user profile -> trips
 #not registered - all this user's, no others
 #guest - all this user's, no others
 #user - all this user's, no others


#home page trips - last 3 by user by date


#sort by date vs NS

################################

# View a trip 

 #title
 # descrition
 # DownloadGPX
 #length 
#distance
#distance with nulls
#distance all null
#time
#time with nulls
#time all nulls

#difficulty stats

#place
#route
#muliiple places
#multiple routes
#reverse route
#no entries



#links none
#links place
#links route
#links story
#links photo
#links url

#comments none
#comments one
#comments many

#permissions
  #not logged in - no edit
  #guest - own trip - edit
  #guest - others trip - no edit
  #user - own trip - edit
  #user - others trip - no edit
  #root - others trip - edit

#draft trips
  #title Draft: title

#####################################

#Edit a trip
  #Fileds and values

  #Handling nulls

  #Cannot edit (not registered) - cannot view edit form, cannot post

  #CAnnot edit others (guest) - cannot view edit form, cannot post

  #CAnnot edit others (user) - cannot view edit form, cannot post

  #Can edit own (guest)

  #Can edit own (user)

  #Can edit others (root)

  #missing mandatory fields (name)

#Reordering a trip    
  #Cut 1st, paste last
  #Cut last, paste middle
  #Cut middle, paste first
  #Cut middle, delete
  #Cut last, delete
  #Cut 1st, delete
  #Delete all
  #Guest can reorder own
  #USer can reorder own
  #Root can reorder others
  #user cannot reorder others (post)
  #guest cannot reorder others (post)
  #unregistered cannot reorder any (post)

#deleting a trip
  #Guest can delete own
  #USer can delete own
  #Root can delete others
  #user cannot delete others (post)
  #guest cannot delete others (post)
  #unregistered cannot delete any (post)

#download GPX
end

